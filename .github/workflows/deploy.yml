name: Deploy

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    GCP_PROJECT_ID: slap-ai-481400
    GCP_PROJECT_NUMBER: "578398115938"
    GCP_REGION: us-central1
    API_SERVICE_NAME: ai-learning-api
    ARTIFACT_REGISTRY_REPO: ai-learning
    IMAGE_NAME: api

jobs:
    deploy:
        name: Deploy API
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              id: auth
              uses: google-github-actions/auth@v2
              with:
                  token_format: "access_token"
                  workload_identity_provider: projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-deploy-pool/providers/github-provider
                  service_account: ai-study-uploader@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com
                  audience: //iam.googleapis.com/projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-deploy-pool/providers/github-provider

            - name: Set up gcloud CLI
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ env.GCP_PROJECT_ID }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Artifact Registry
              uses: docker/login-action@v3
              with:
                  registry: us-central1-docker.pkg.dev
                  username: oauth2accesstoken
                  password: ${{ steps.auth.outputs.access_token }}

            - name: Get Secrets from Secret Manager
              id: secrets
              uses: google-github-actions/get-secretmanager-secrets@v2
              with:
                  secrets: |-
                      db_url:projects/${{ env.GCP_PROJECT_ID }}/secrets/AI_LEARNING_DB_URL
                      google_api_key:projects/${{ env.GCP_PROJECT_ID }}/secrets/AI_LEARNING_GOOGLE_API_KEY
                      jwt_secret:projects/${{ env.GCP_PROJECT_ID }}/secrets/AI_LEARNING_JWT_SECRET
                      gcs_bucket_name:projects/${{ env.GCP_PROJECT_ID }}/secrets/AI_LEARNING_GCS_BUCKET_NAME
                      pubsub_topic_id:projects/${{ env.GCP_PROJECT_ID }}/secrets/AI_LEARNING_PUBSUB_TOPIC_ID
                      file_store_name:projects/${{ env.GCP_PROJECT_ID }}/secrets/AI_LEARNING_FILE_STORE_NAME

            - name: Run Database Migrations
              env:
                  DB_URL: ${{ steps.secrets.outputs.db_url }}
              run: |
                  go install github.com/pressly/goose/v3/cmd/goose@latest
                  goose -dir internal/persistance/migrations postgres "$DB_URL" up

            - name: Build and Push Docker Image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  platforms: linux/amd64
                  push: true
                  tags: us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:latest,us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy ${{ env.API_SERVICE_NAME }} \
                    --image us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                    --project ${{ env.GCP_PROJECT_ID }} \
                    --region ${{ env.GCP_REGION }} \
                    --port 8080 \
                    --timeout 600 \
                    --allow-unauthenticated \
                    --no-cpu-throttling \
                    --service-account ai-study-uploader@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
                    --set-secrets=DB_URL=AI_LEARNING_DB_URL:latest \
                    --set-secrets=GOOGLE_API_KEY=AI_LEARNING_GOOGLE_API_KEY:latest \
                    --set-secrets=JWT_SECRET=AI_LEARNING_JWT_SECRET:latest \
                    --set-secrets=GCS_BUCKET_NAME=AI_LEARNING_GCS_BUCKET_NAME:latest \
                    --set-secrets=PUBSUB_TOPIC_ID=AI_LEARNING_PUBSUB_TOPIC_ID:latest \
                    --set-secrets=FILE_STORE_NAME=AI_LEARNING_FILE_STORE_NAME:latest \
                    --set-env-vars GOOGLE_PROJECT_ID=${{ env.GCP_PROJECT_ID }},PORT=8080 \
                    --quiet
