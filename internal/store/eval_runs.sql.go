// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: eval_runs.sql

package store

import (
	"context"
	"database/sql"
	"encoding/json"

	"github.com/google/uuid"
	"github.com/sqlc-dev/pqtype"
)

const createEvalRun = `-- name: CreateEvalRun :one
INSERT INTO eval_runs (
  artifact_id,
  generation_run_id,
  suite_id,
  judge_model,
  judge_params,
  status,
  started_at
) VALUES (
  $1,        -- artifact_id
  $2,        -- generation_run_id (nullable)
  $3,        -- suite_id
  $4,        -- judge_model
  $5,        -- judge_params :: jsonb
  'RUNNING',
  now()
)
RETURNING id, artifact_id, generation_run_id, suite_id, judge_model, judge_params, status, overall_pass, overall_score, error, started_at, finished_at, created_at
`

type CreateEvalRunParams struct {
	ArtifactID      uuid.UUID       `json:"artifact_id"`
	GenerationRunID uuid.NullUUID   `json:"generation_run_id"`
	SuiteID         uuid.UUID       `json:"suite_id"`
	JudgeModel      string          `json:"judge_model"`
	JudgeParams     json.RawMessage `json:"judge_params"`
}

func (q *Queries) CreateEvalRun(ctx context.Context, arg CreateEvalRunParams) (EvalRun, error) {
	row := q.db.QueryRowContext(ctx, createEvalRun,
		arg.ArtifactID,
		arg.GenerationRunID,
		arg.SuiteID,
		arg.JudgeModel,
		arg.JudgeParams,
	)
	var i EvalRun
	err := row.Scan(
		&i.ID,
		&i.ArtifactID,
		&i.GenerationRunID,
		&i.SuiteID,
		&i.JudgeModel,
		&i.JudgeParams,
		&i.Status,
		&i.OverallPass,
		&i.OverallScore,
		&i.Error,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
	)
	return i, err
}

const deleteEvalRun = `-- name: DeleteEvalRun :exec
DELETE FROM eval_runs
WHERE id = $1
`

func (q *Queries) DeleteEvalRun(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.ExecContext(ctx, deleteEvalRun, id)
	return err
}

const getEvalRunByID = `-- name: GetEvalRunByID :one
SELECT id, artifact_id, generation_run_id, suite_id, judge_model, judge_params, status, overall_pass, overall_score, error, started_at, finished_at, created_at
FROM eval_runs
WHERE id = $1
LIMIT 1
`

func (q *Queries) GetEvalRunByID(ctx context.Context, id uuid.UUID) (EvalRun, error) {
	row := q.db.QueryRowContext(ctx, getEvalRunByID, id)
	var i EvalRun
	err := row.Scan(
		&i.ID,
		&i.ArtifactID,
		&i.GenerationRunID,
		&i.SuiteID,
		&i.JudgeModel,
		&i.JudgeParams,
		&i.Status,
		&i.OverallPass,
		&i.OverallScore,
		&i.Error,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
	)
	return i, err
}

const getLatestEvalRunForArtifact = `-- name: GetLatestEvalRunForArtifact :one
SELECT id, artifact_id, generation_run_id, suite_id, judge_model, judge_params, status, overall_pass, overall_score, error, started_at, finished_at, created_at
FROM eval_runs
WHERE artifact_id = $1
ORDER BY created_at DESC
LIMIT 1
`

func (q *Queries) GetLatestEvalRunForArtifact(ctx context.Context, artifactID uuid.UUID) (EvalRun, error) {
	row := q.db.QueryRowContext(ctx, getLatestEvalRunForArtifact, artifactID)
	var i EvalRun
	err := row.Scan(
		&i.ID,
		&i.ArtifactID,
		&i.GenerationRunID,
		&i.SuiteID,
		&i.JudgeModel,
		&i.JudgeParams,
		&i.Status,
		&i.OverallPass,
		&i.OverallScore,
		&i.Error,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
	)
	return i, err
}

const listEvalRunsByArtifact = `-- name: ListEvalRunsByArtifact :many
SELECT id, artifact_id, generation_run_id, suite_id, judge_model, judge_params, status, overall_pass, overall_score, error, started_at, finished_at, created_at
FROM eval_runs
WHERE artifact_id = $1
ORDER BY created_at DESC
`

func (q *Queries) ListEvalRunsByArtifact(ctx context.Context, artifactID uuid.UUID) ([]EvalRun, error) {
	rows, err := q.db.QueryContext(ctx, listEvalRunsByArtifact, artifactID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []EvalRun
	for rows.Next() {
		var i EvalRun
		if err := rows.Scan(
			&i.ID,
			&i.ArtifactID,
			&i.GenerationRunID,
			&i.SuiteID,
			&i.JudgeModel,
			&i.JudgeParams,
			&i.Status,
			&i.OverallPass,
			&i.OverallScore,
			&i.Error,
			&i.StartedAt,
			&i.FinishedAt,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateEvalRunResult = `-- name: UpdateEvalRunResult :one
UPDATE eval_runs
SET
  status = $2,          -- run_status
  overall_pass = $3,    -- boolean
  overall_score = $4,   -- real
  finished_at = now(),
  error = $5            -- jsonb (nullable)
WHERE id = $1
RETURNING id, artifact_id, generation_run_id, suite_id, judge_model, judge_params, status, overall_pass, overall_score, error, started_at, finished_at, created_at
`

type UpdateEvalRunResultParams struct {
	ID           uuid.UUID             `json:"id"`
	Status       string                `json:"status"`
	OverallPass  sql.NullBool          `json:"overall_pass"`
	OverallScore sql.NullFloat64       `json:"overall_score"`
	Error        pqtype.NullRawMessage `json:"error"`
}

func (q *Queries) UpdateEvalRunResult(ctx context.Context, arg UpdateEvalRunResultParams) (EvalRun, error) {
	row := q.db.QueryRowContext(ctx, updateEvalRunResult,
		arg.ID,
		arg.Status,
		arg.OverallPass,
		arg.OverallScore,
		arg.Error,
	)
	var i EvalRun
	err := row.Scan(
		&i.ID,
		&i.ArtifactID,
		&i.GenerationRunID,
		&i.SuiteID,
		&i.JudgeModel,
		&i.JudgeParams,
		&i.Status,
		&i.OverallPass,
		&i.OverallScore,
		&i.Error,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
	)
	return i, err
}
